name: Multi-Platform Parallel Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
  
permissions:
  contents: write
  deployments: write

jobs:
  # ==========================================
  # ä»»åŠ¡ 1: ç»Ÿä¸€æ„å»º (Single Build Source)
  # ==========================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Setup Node.js âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install and Build ğŸ”§
        run: |
          npm ci
          npm run build

      - name: Prepare Platform Configs ğŸš€
        run: |
          cp dist/index.html dist/404.html
          
          # ç”Ÿæˆ Vercel é…ç½®
          cp vercel.json dist/ || echo '{"rewrites": [{"source": "/(.*)", "destination": "/index.html"}]}' > dist/vercel.json
          
          # ç”Ÿæˆ Cloudflare é…ç½®
          echo "/* /index.html 200" > dist/_redirects
          
          # ç”Ÿæˆ Apache/Serv00 é…ç½® (.htaccess)
          touch dist/.htaccess
          cat <<EOF > dist/.htaccess
          # Fallback: standard Apache error document
          ErrorDocument 404 /index.html

          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
          </IfModule>
          EOF
          
          # Serv00 å®˜æ–¹æ¨è: errors/404.html
          # å°† index.html å¤åˆ¶ä¸º 404 é¡µé¢ï¼Œä½œä¸º SPA è·¯ç”±çš„ fallback
          mkdir -p dist/errors
          cp dist/index.html dist/errors/404.html

      - name: Upload Build Artifact ğŸ“¦
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist/
          retention-days: 1
          include-hidden-files: true

  # ==========================================
  # ä»»åŠ¡ 1.1: Aliyun ä¸“ç”¨æ„å»º (With ICP)
  # ==========================================
  build-aliyun:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Setup Node.js âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install and Build (Target Aliyun) ğŸ”§
        env:
          VITE_SHOW_ICP: 'true'
        run: |
          npm ci
          npm run build

      - name: Upload Build Artifact ğŸ“¦
        uses: actions/upload-artifact@v4
        with:
          name: site-dist-aliyun
          path: dist/
          retention-days: 1
          include-hidden-files: true

  # ==========================================
  # ä»»åŠ¡ 2: éƒ¨ç½²åˆ° GitHub Pages (gh.couuas.pp.ua)
  # ==========================================
  deploy-github:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: dist/

      - name: Deploy to GitHub Pages ğŸš€
        uses: peaceiris/actions-gh-pages@v4
        with:
          deploy_key: ${{ secrets.ACCESS_TOKEN }}
          external_repository: couuas/couuas.github.io
          publish_branch: main
          publish_dir: ./dist
          commit_message: "Deploy: ${{ github.event.head_commit.message }}"
          force_orphan: true

  # ==========================================
  # ä»»åŠ¡ 3: éƒ¨ç½²åˆ° Cloudflare Pages (cf.couuas.pp.ua)
  # ==========================================
  deploy-cloudflare:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: dist/

      - name: Deploy to Cloudflare Pages â˜ï¸
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: wasker-vue 
          directory: ./dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # ä»»åŠ¡ 4: éƒ¨ç½²åˆ° Vercel (vc.couuas.pp.ua)
  # ==========================================
  deploy-vercel:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download Artifact ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: dist/

      - name: Deploy to Vercel ğŸ“
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
          vercel-project-name: wasker-vue 

  # ==========================================
  # ä»»åŠ¡ 5: éƒ¨ç½²åˆ° Serv00 Host (SSH)
  # ==========================================
  deploy-serv00:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: dist/

      - name: Deploy to Serv00 ğŸš€
        run: |
          # Install sshpass to support password authentication for scp
          sudo apt-get update && sudo apt-get install -y sshpass
          
          # Use sshpass with scp to transfer files
          # Make sure to include the errors directory
          export SSHPASS="${{ secrets.SSH_PASSWORD }}"
          sshpass -e scp -O -o StrictHostKeyChecking=no -P 22 -r dist/* dist/.htaccess ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/home/pwdoko/domains/se.couuas.pp.ua/public_html/

  # ==========================================
  # ä»»åŠ¡ 6: éƒ¨ç½²åˆ° é˜¿é‡Œäº‘ 1Panel (SSH)
  # ==========================================
  deploy-aliyun:
    needs: build-aliyun
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: site-dist-aliyun
          path: dist/

      - name: Deploy to Aliyun via SCP ğŸš€
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}
          port: 22
          source: "dist/*"
          target: "/opt/1panel/apps/openresty/openresty/www/sites/19980515.xyz/index" 
          strip_components: 1